# 分布式一致性

### 什么是分布式系统？

> 分布式系统是一个硬件或软件组件分布在不同的网络计算机上，彼此之间仅仅通过消息传递进行通信和协调。

### 分布式系统有哪些特征？

- 分布性

- 对等性

  > 所有计算机节点对等。
  >
  > 副本有两种
  >
  > - 数据副本：在不同节点上持久化同一份数据
  > - 服务副本：多个节点提供同样的服务；

- 并发性

- 缺乏全局时钟

  > 很难定义两个事件究竟谁先谁后

- 故障总是会发生

### 分布式环境会遇到的问题有哪些？

- 通信异常
  - 网络不可用
  - 消息丢失
  - 消息延时(超时)
- 网络分区——脑裂
- 三态
  - 成功
  - 失败
  - 超时
    - 消息没有被成功的发送到接收方，发送过程中丢失消息；
    - 消息成功被接受后，响应时丢失了消息；
- 节点故障

### 什么是CAP定理?

```
CAP理论告诉我们一个分布式系统不可能同时满足一致性、可用性和分区容错性。
```

- C(Consistency)一致性

  > 数据在多个副本之间是否能够保持一致性
  >
  > 放弃一致性，是指放弃数据的强一致性

- A(Availavility)可用性

  > 系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够在有限地时间内返回结果
  >
  > 放弃可用性，是指在系统遇到故障时，受影响的服务需要等待一段时间，等待期间系统无法对外提供服务

- P(Partition tolerance)分区容错性

  > 分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务
  >
  > 放弃分区容错性，一种简单做法是将所有数据都放在一个分布式节点上，意味着放弃了可扩展性
  >
  > 对于分布式系统而言，分区容错性是一个基本要求

### 什么是BASE理论？

```
BASE是对CAP中一致性和可用性权衡的结果，核心思想是即使无法做到强一致性，但应用可以以适当的方式达到最终一致性。
```

- BA(Basically Available)基本可用

  > 在系统遇到故障的时候，允许系统损失部分可用性
  >
  > - 响应时间上损失
  > - 功能上损失

- S(Soft state)软状态

  > 允许系统中的数据存在中间状态，允许系统在不同副本之间的同步存在延时

- E(Eventually consistent)最终一致性

  > 系统中的所有副本，在经过一段时间同步后，最终能够达到一个一致状态
  >
  > - 因果一致性：A修改值后，通知B；B之后对数据的访问应该能获取到A修改之后的值
  > - 读己之所写
  > - 会话一致性
  > - 单调读一致性：如果一个进程从系统中读出一个数据项的某个值后，系统对于该进程后续的任何数据访问都不应该返回一个更旧的值
  > - 单调写一致性：保证来自同一个进程的写操作按顺序执行

### 什么是两阶段提交？

- 提交事务请求
  - 协调者向所有参与者发送事务请求，并等待各参与者响应
  - 各参与者节点执行事务操作
  - 各参与者向协调者反馈

- 执行事务提交(所有参与者都反馈Yes)
  - 协调者向所有参与者节点发送Commit请求
  - 参与者提交事务，并释放资源
  - 参与者向协调者发送Ack消息
  - 事务完成
- 事务中断(任何一个参与者反馈No，或等待超时)
  - 协调者向所有参与者发送Rollback请求
  - 参与者执行事务回滚操作
  - 参与者向协调者发送Ack消息
  - 完成事务中断

### 两阶段提交有什么问题？

- 同步阻塞

  > 执行过程中，所有参与事务操作的逻辑都处于阻塞状态，等待其他参与者响应过程中，无法进行任何其他操作。

- 单点

  > 协调者单点，一旦协调者故障，参与者会一直阻塞

- 数据不一致

  > 协调者发送commit消息后，发生网络故障，只有部分参与者接收到commit消息，导致数据不一致；

- 保守

  > 没有容错机制，任意一个节点失败都会导致整个事务失败

- 无法解决的问题

  > 协调者发出Commit消息后宕机，唯一接收到消息的参与者也宕机，即使重新选举出协调者，也无法确定该条事务的状态

### 什么是三阶段提交？

> 相对于两阶段提交
>
> - 引入超时机制
>   - PreCommit阶段，协调者等待参与者反馈超时，abort
>   - DoCommit阶段，参与者等待协调者发送指令超时，仍然完成提交
> - 增加一个准备阶段，保证在最后提交阶段前个参与节点状态一直

- CanCommit
  - 协调者向所有参与者询问是否可以执行事务，并等待各参与者响应
  - 参与者反馈
- PreCommit(所有参与者都反馈Yes)
  - 协调者向所有参与者发出preCommit请求，并进入prepared阶段
  - 参与者执行事务操作
  - 参与者向协调者反馈
- 中断事务(任何一个参与者反馈No，或者等待参与者反馈超时)
  - 协调者向所有参与者发送abort请求
  - 参与者中断事务(无论接收到abort请求或者等待超时)

- DoCommit(协调者接收到了所有参与者的Ack响应)

  > 参与者无法及时接收到来自协调者的DoCommit或者abort消息，会在等待超时后，继续进行事务提交

  - 协调者向所有参与者发送DoCommit请求
  - 参与者执行事务提交，释放资源
  - 参与者向协调者发送Ack消息
  - 协调者接收到所有参与者的Ack消息后，完成事务

- 中断事务(任何一个参与者反馈No)

  - 协调者向所有参与者发送abort请求
  - 参与者回滚事务
  - 参与者向协调者发送Ack消息
  - 协调者接收到所有参与者反馈的Ack消息后，中断事务

### 三阶段提交有哪些优缺点？

- 优点：
  - 降低了参与者的阻塞范围
  - 进入第三阶段后，即使协调者故障，事务仍能提交
- 缺点：
  - 参与者接收到PreCommit消息后，如果出现网络分区，如果协调者发出了abort请求，但参与者无法与协调者正常通信，参与者等待超时后依然会提交事务，导致数据不一致。

### 什么是分布式一致性？

### 分布式一致性分为哪些类型？

### 分布式系统达到一致性后将会是什么状态？

### 如果失去了一致性约束，分布式系统是否还可以依赖？

### 如果仅追求一致性，对系统整体架构和性能有多大影响？